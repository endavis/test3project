# Codex CLI Configuration
# Location: ~/.codex/config.toml or project-specific .codex/config.toml
#
# This configuration whitelists common development commands for Python projects
# using uv, doit, git, and GitHub CLI.
#
# SECURITY: Dangerous commands are blocked below. See AGENTS.md for rules.

# Default approval policy
default_policy = "untrusted"  # Prompt before running untrusted commands

# =============================================================================
# BLOCKED COMMANDS - These bypass security controls
# =============================================================================

# Block --admin flag (bypasses branch protection)
[[approval_policy]]
type = "command"
pattern = "--admin"
action = "deny"
reason = "BLOCKED: --admin bypasses branch protection rules. See AGENTS.md."

# Block --force flag (can cause data loss)
[[approval_policy]]
type = "command"
pattern = "--force\\b"
action = "deny"
reason = "BLOCKED: --force can cause data loss. See AGENTS.md."

# Block --no-verify flag (skips pre-commit hooks)
[[approval_policy]]
type = "command"
pattern = "--no-verify"
action = "deny"
reason = "BLOCKED: --no-verify skips security hooks. See AGENTS.md."

# Block force push variants
[[approval_policy]]
type = "command"
pattern = "git\\s+push.*-f\\b"
action = "deny"
reason = "BLOCKED: Force push can overwrite remote history. See AGENTS.md."

[[approval_policy]]
type = "command"
pattern = "--force-with-lease"
action = "deny"
reason = "BLOCKED: Force push variant. See AGENTS.md."

# Block git reset --hard (can lose uncommitted changes)
[[approval_policy]]
type = "command"
pattern = "git\\s+reset\\s+--hard"
action = "deny"
reason = "BLOCKED: Hard reset can lose uncommitted changes. See AGENTS.md."

# Block destructive rm commands
[[approval_policy]]
type = "command"
pattern = "rm\\s+-rf\\s+/"
action = "deny"
reason = "BLOCKED: Destructive command - removes filesystem. See AGENTS.md."

[[approval_policy]]
type = "command"
pattern = "rm\\s+-rf\\s+~"
action = "deny"
reason = "BLOCKED: Destructive command - removes home directory. See AGENTS.md."

# Block direct gh issue/pr create - use doit wrappers instead
[[approval_policy]]
type = "command"
pattern = "gh\\s+issue\\s+create"
action = "deny"
reason = "BLOCKED: Use 'doit issue --type=<type>' instead of 'gh issue create'. See AGENTS.md."

[[approval_policy]]
type = "command"
pattern = "gh\\s+pr\\s+create"
action = "deny"
reason = "BLOCKED: Use 'doit pr' instead of 'gh pr create'. See AGENTS.md."

# =============================================================================
# ALLOWED COMMANDS - Standard development tools
# =============================================================================

# Whitelist standard development tools
[[approval_policy]]
type = "command"
pattern = "^(git|gh|uv|doit|ls|cat|tree|find|grep|wc|mkdir|python|pytest|ruff|mypy)\\b"
action = "allow"
reason = "Standard development and version control tools"

# Allow specific git operations
[[approval_policy]]
type = "command"
pattern = "^git\\s+(status|diff|log|add|commit|push|pull|fetch|checkout|branch|merge|stash|reset|rebase|remote)"
action = "allow"
reason = "Common git operations"

# Allow GitHub CLI operations
[[approval_policy]]
type = "command"
pattern = "^gh\\s+(auth|pr|issue|run|api)"
action = "allow"
reason = "GitHub CLI operations"

# Allow uv package management
[[approval_policy]]
type = "command"
pattern = "^uv\\s+(pip|venv|build|publish|run|sync)"
action = "allow"
reason = "UV package manager operations"

# Allow doit task automation
[[approval_policy]]
type = "command"
pattern = "^doit\\s+(list|test|coverage|lint|format|check|build|cleanup)"
action = "allow"
reason = "Doit task automation"

# Shell environment policy - whitelist safe environment variables
[shell_env_policy]
include_only = [
    "PATH",
    "HOME",
    "USER",
    "UV_CACHE_DIR",
    "VIRTUAL_ENV",
    "PYTHONPATH",
]
exclude = [
    "*_API_KEY",
    "*_SECRET",
    "*_TOKEN",
    "PASSWORD",
    "PYPI_TOKEN",
    "CODECOV_TOKEN",
]

# Sandbox mode (optional - set to false for local development)
# sandbox_mode = false

# Network access policy
# network_access = "prompt"  # Options: "allow", "deny", "prompt"
